<div class="container">

  <!-- For Initiating user -->
  <div class="user-initiate">
    <p class="heading">Initiate User</p>
    <div>
      <form [formGroup]="userInitiateForm">

        <mat-form-field class="form-control">
          <input
            matInput
            placeholder="Enter User ID"
            formControlName="id"
          />
        </mat-form-field>

        <div formArrayName="userGroups">
          <div *ngFor="let group of userGroups.controls; let index = index">
            <ng-container [formGroupName]="index">
              <mat-form-field class="form-control">
                <mat-label>Group Type</mat-label>
                <mat-select formControlName="groupType">
                  <mat-option
                    *ngFor="let groupType of groupList[index]"
                    [value]="groupType.value"
                  >
                    {{ groupType.value | titlecase }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field
                class="form-control"
                *ngIf="groupTypeValue(index)"
              >
                <input
                  matInput
                  placeholder="Enter Group Name"
                  formControlName="customGroupName"
                />
              </mat-form-field>

              <mat-form-field class="form-control">
                <input
                  matInput
                  placeholder="Group ID"
                  formControlName="groupId"
                />
              </mat-form-field>

              <mat-icon
                *ngIf="index !== 0"
                class="icons"
                (click)="removeUserGroup(index)"
              >delete</mat-icon>
            </ng-container>
          </div>
        </div>

        <span class="validation-message" *ngIf="userInitiateForm.hasError('customGroupNameError')">
          Custom Group Names should not same
        </span>

        <button
          type="button"
          class="add-user-group"
          (click)="addNewUserGroup()"
        >
          + Add New Group
        </button>

        <button
          mat-raised-button
          class="default-button form-control"
          [ngClass]="{'default-button--disabled': !userInitiateForm.valid}"
          [disabled]="!userInitiateForm.valid"
          (click)="initiateUser()"
        >
          Initiate User
        </button>

      </form>
    </div>
    <p *ngIf="selectedUser">{{ 'Current User : '+ selectedUser?.id }}</p>
  </div>

  <!-- For Experiment Partition Info -->
  <div class="experiment-partition">
    <p class="heading">Experiment Partition Information</p>
    <div class="experiment-partition-view">
      <form class="experiment-partition-form" [formGroup]="experimentPartitionForm">

        <div formArrayName="partitions">
          <div *ngFor="let group of partitionInfo.controls; let index = index">
            <ng-container [formGroupName]="index">
              <mat-form-field class="form-control">
                <input
                  matInput
                  placeholder="Partition Name"
                  formControlName="partitionName"
                />
              </mat-form-field>

              <mat-form-field class="form-control">
                <input
                  matInput
                  placeholder="Partition Point"
                  formControlName="partitionPoint"
                />
              </mat-form-field>

              <mat-icon
                class="icons"
                (click)="removePartition(index)"
              >delete</mat-icon>
            </ng-container>
          </div>
        </div>

        <button
          type="button"
          class="add-partition"
          (click)="addNewPartition()"
        >
          + Add New Partition
        </button>

        <button
          mat-raised-button
          class="default-button form-control"
          [ngClass]="{'default-button--disabled': !experimentPartitionForm.valid}"
          [disabled]="!experimentPartitionForm.valid"
          (click)="savePartitionInfo()"
        >
          Add Partition
        </button>

      </form>

      <table
        *ngIf="listOfExperimentPoints.length"
        mat-table
        [dataSource]="listOfExperimentPoints"
        class="mat-elevation-z8 experiment-point-table"
      >

        <!--- Note that these columns can be defined in any order.
              The actual rendered columns are set as a property on the row definition" -->

        <!-- Position Column -->
        <ng-container matColumnDef="no">
          <th mat-header-cell *matHeaderCellDef> No. </th>
          <td mat-cell *matCellDef="let element; let index = index">{{ index + 1 }}</td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="partitionName">
          <th mat-header-cell *matHeaderCellDef> Partition Name </th>
          <td mat-cell *matCellDef="let element"> {{element.partitionName}} </td>
        </ng-container>

        <!-- Weight Column -->
        <ng-container matColumnDef="partitionPoint">
          <th mat-header-cell *matHeaderCellDef> Partition Point </th>
          <td mat-cell *matCellDef="let element"> {{element.partitionPoint}} </td>
        </ng-container>

        <!-- Symbol Column -->
        <ng-container matColumnDef="removePartition">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element; let index = index">
            <mat-icon
                class="icons"
                (click)="removePartitionFromSavedList(index)"
            >delete</mat-icon>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsPoints"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsPoints;"></tr>
      </table>
    </div>
  </div>

  <!-- For Assigned Condition -->
  <div class="assigned-condition">
    <p class="heading">Assigned Condition</p>
    <div class="assigned-condition-view">
      <table
        *ngIf="assignedConditions.length; else noExperimentForMark"
        mat-table
        [dataSource]="assignedConditions"
        class="mat-elevation-z8 assigned-condition-table"
      >

        <!-- Position Column -->
        <ng-container matColumnDef="no">
          <th mat-header-cell *matHeaderCellDef> No. </th>
          <td mat-cell *matCellDef="let element; let index = index">{{ index + 1 }}</td>
        </ng-container>

        <!-- Point Column -->
        <ng-container matColumnDef="point">
          <th mat-header-cell *matHeaderCellDef> Partition Point </th>
          <td mat-cell *matCellDef="let element"> {{ element.point }} </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef> Partition Name </th>
          <td mat-cell *matCellDef="let element"> {{ element.name }} </td>
        </ng-container>

        <!-- Condition Code Column -->
        <ng-container matColumnDef="conditionCode">
          <th mat-header-cell *matHeaderCellDef> Condition Code </th>
          <td mat-cell *matCellDef="let element"> {{ element.assignedCondition?.conditionCode }} </td>
        </ng-container>

        <!-- Condition Weight Column -->
        <ng-container matColumnDef="assignmentWeight">
          <th mat-header-cell *matHeaderCellDef> Condition Weight </th>
          <td mat-cell *matCellDef="let element"> {{ element.assignedCondition?.assignmentWeight }} </td>
        </ng-container>

        <!-- Condition Description Column -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef> Condition Description </th>
          <td mat-cell *matCellDef="let element"> {{ element.assignedCondition?.description }} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnMarkExperiment"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnMarkExperiment;"></tr>
      </table>
      <ng-template #noExperimentForMark>
        <div class="assigned-condition-zero-state">
          <span>Zero Conditions assigned</span>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- For Mark Experiment -->
  <p class="heading">Mark Experiment</p>
    <div class="mark-experiment-view">

      <form [formGroup]="markExperimentForm">
        <mat-form-field class="form-control">
          <input
            matInput
            placeholder="Partition Name"
            aria-label="Partition Name"
            [matAutocomplete]="markExperimentName"
            formControlName="markExperimentName"
          >
          <mat-autocomplete #markExperimentName="matAutocomplete">
            <mat-option *ngFor="let partition of filterMarkExperimentNames$ | async" [value]="partition.partitionName">
              <span>{{ partition.partitionName }}</span>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field class="form-control">
          <input
            matInput
            placeholder="Partition Point"
            aria-label="Partition Point"
            [matAutocomplete]="markExperimentPoint"
            formControlName="markExperimentPoint"
          >
          <mat-autocomplete #markExperimentPoint="matAutocomplete">
            <mat-option *ngFor="let partition of filterMarkExperimentPoints$ | async" [value]="partition.partitionPoint">
              <span>{{ partition.partitionPoint }}</span>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </form>

      <button
        mat-raised-button
        class="default-button form-control mark-experiment-btn"
        [ngClass]="{'default-button--disabled': !markExperimentForm.valid || !selectedUser?.id}"
        [disabled]="!markExperimentForm.valid || !selectedUser?.id"
        (click)="markExperiment()"
      >
        Mark Experiment
      </button>
    </div>

  </div>
